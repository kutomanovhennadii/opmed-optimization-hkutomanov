\## 3.2.8 - Orchestration Interface (run.py)



\### Purpose

The orchestration layer (`run.py`) serves as the unified entry point for the Opmed optimization system.  

It coordinates all modules—DataLoader, ModelBuilder, Optimizer, Validator, Visualizer, and Metrics—into a reproducible pipeline.  

This interface defines the full process of loading inputs, building and solving the model, validating results, producing plots, and writing all output artifacts.



---



\### Function Signature

run(config\_path: Path, surgeries\_path: Path, output\_dir: Path) -> RunArtifacts





---



\### RunArtifacts Structure

`RunArtifacts = { solution\_csv, metrics\_json, solver\_log, solution\_plot, validation\_report }`



| Key | Type | Description |

|------|------|-------------|

| solution\_csv | Path | Path to final schedule (assignments) |

| metrics\_json | Path | Path to metrics summary file |

| solver\_log | Path | Path to human-readable solver log |

| solution\_plot | Path | Path to visualization PNG |

| validation\_report | Path | Path to validation\_report.json |



---



\### Contracts



\*\*Preconditions\*\*

\- `config\_path` and `surgeries\_path` refer to existing, readable files.  

\- `output\_dir` exists or can be created.  

\- All core modules are importable within the `opmed` package.  

\- The CP-SAT solver environment (OR-Tools) is available.



\*\*Postconditions\*\*

\- A new subdirectory is created: `output\_dir/run\_<timestamp>/`.  

\- The following artifacts are guaranteed to exist:



solution.csv

metrics.json

solver.log

solution\_plot.png

validation\_report.json



\- Each artifact is internally consistent and stamped with the same configuration hash (`cfg\_hash`).  

\- Returns a `RunArtifacts` dictionary with absolute paths to all generated files.



\*\*Errors\*\*

\- `IOError`: input or output file access failure.  

\- `ConfigError`: malformed or invalid config file.  

\- `SolveError`: solver failed or returned an undefined state.  

\- `ValidationError`: report could not be generated.  

\- All exceptions are logged in solver.log and handled gracefully.



---



\### Execution Order and Module Interaction



1\. \*\*Data Loading\*\*

cfg = load\_config(config\_path)

surgeries = load\_surgeries(surgeries\_path, cfg.time\_unit)



→ produces validated Config and Surgery list.



2\. \*\*Model Building\*\*



bundle = build\_model(surgeries, cfg)



→ creates CpSatModelBundle = {model, vars, aux, metadata}.



3\. \*\*Optimization\*\*





result = solve(bundle, cfg)



→ runs CP-SAT, returns SolveResult with assignments, status, logs.



4\. \*\*Metrics \& Logging\*\*





metrics = collect\_metrics(result, cfg)

write\_metrics(metrics, output\_dir)



→ generates metrics.json and solver.log (per ADR-006).



5\. \*\*Validation\*\*





report = validate\_assignments(result.assignments, surgeries, cfg)



→ writes validation\_report.json (valid/invalid flag).



6\. \*\*Visualization\*\*





plot\_schedule(result.assignments, surgeries, cfg, output\_dir / "solution\_plot.png")



→ saves solution\_plot.png using the client visualization code.



7\. \*\*Return Artifacts\*\*





return {

"solution\_csv": output\_dir / "solution.csv",

"metrics\_json": output\_dir / "metrics.json",

"solver\_log": output\_dir / "solver.log",

"solution\_plot": output\_dir / "solution\_plot.png",

"validation\_report": output\_dir / "validation\_report.json"

}





---



\### Behavior by Status Code



| Solver Status | Validator | Visualization | Metrics |

|----------------|------------|----------------|----------|

| INFEASIBLE | skipped | optional | recorded |

| FEASIBLE | executed | executed | recorded |

| OPTIMAL | executed | executed | recorded |

| UNKNOWN | executed | executed | recorded with warning |



If `VALIDATOR.valid == false`, the visualization and metrics are still produced but marked `"valid": false` in metrics.json.



---



\### Integration

\- Entry point for CLI, Airflow DAGs, and CI/CD pipelines.  

\- Responsible for experiment reproducibility and metadata consistency.  

\- Every artifact written includes `cfg\_hash` to link runs.  

\- Execution time and exceptions logged in `solver.log`.



---



\### Summary

The orchestration interface defines the top-level workflow for the Opmed optimization system.  

It ensures deterministic execution order, complete artifact generation, consistent metadata,  

and alignment with ADR-006 (logging and metrics) and ADR-007 (reproducibility).





















































































