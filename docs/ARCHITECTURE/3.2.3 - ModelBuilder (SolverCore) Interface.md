\## 3.2.3 - ModelBuilder (SolverCore) Interface (updated for tuning)



\### Purpose

ModelBuilder constructs the CP-SAT optimization model from validated inputs.  

This update makes model construction fully parameterized via Config and exposes metadata needed for hyperparameter tuning and reproducibility.



---



\### Function Signature (updated)

build\_model(

surgeries: list\[Surgery],

cfg: Config,

variable\_callback: Optional\[Callable\[\[dict], None]] = None

) -> CpSatModelBundle





\- `variable\_callback`: optional hook called after variable creation. It receives the `vars` dict so callers can adjust priorities, hints, or tagging before solving. No side effects outside the bundle are allowed.



---



\### Output Structure



`CpSatModelBundle = { model, vars, aux, metadata }`



| Key      | Type    | Description |

|----------|---------|-------------|

| model    | CpModel | OR-Tools CP-SAT model instance |

| vars     | dict    | Named decision variables (BoolVar/IntVar/IntervalVar) grouped by role |

| aux      | dict    | Derived constants, indices, and helper maps used by Validator/Visualizer |

| metadata | dict    | Build-time facts for tuning and reproducibility |



`vars` layout (required):

\- `vars\["x"]\[(s,a)] -> BoolVar` (surgery-to-anesthetist)

\- `vars\["y"]\[(s,r)] -> BoolVar` (surgery-to-room)

\- `vars\["active"]\[a] -> BoolVar`

\- `vars\["t\_min"]\[a] -> IntVar`

\- `vars\["t\_max"]\[a] -> IntVar`

\- `vars\["cost"]\[a]  -> IntVar`

\- `vars\["interval"]\[s] -> IntervalVar` (surgery interval in ticks)



`metadata` (required keys):

\- `time\_unit` (float): hours per tick (e.g., 0.0833)

\- `ticks\_per\_hour` (int)

\- `cfg\_hash` (string): stable hash of the effective config used to build the model

\- `modeling\_options` (dict): snapshot of options affecting model shape, e.g.  

&nbsp; - `buffer` (float hours)  

&nbsp; - `enforce\_utilization\_constraint` (bool)  

&nbsp; - `objective\_weights` = { "alpha": float, "beta": float }  

&nbsp; - `branching\_priority\_mode` (string)  

&nbsp; - `use\_lns` (bool) and `lns\_params` (dict)



---



\### Contracts



\*\*Preconditions\*\*

\- `surgeries` is a validated, sorted list (by start\_time) with integer-tick normalization consistent with `cfg.time\_unit`.

\- `cfg` is valid (section 3.2.1) and determines all modeling options used at build time.

\- If `cfg.enforce\_surgery\_duration\_limit = True`, no surgery exceeds the allowed maximum.



\*\*Postconditions\*\*

\- Returns a deterministic `CpSatModelBundle` for the same `surgeries` + `cfg`.

\- All required decision variables exist and are named; `vars` contains stable keys as listed above.

\- All theoretical constraints (see below) are present and consistent.

\- `metadata.cfg\_hash` reflects the effective config; `metadata.modeling\_options` reflects options that change model shape.

\- If provided, `variable\_callback(vars)` has been invoked exactly once after variable creation and before constraint posting or objective finalization.



\*\*Errors\*\*

\- `ModelError`: failed variable creation, inconsistent bounds, or constraint assembly errors.

\- `ConfigError`: missing/invalid configuration affecting model shape (e.g., negative buffer, invalid time\_unit).

\- `DataError`: invalid surgery tick ranges or duplicate identifiers detected at build time.



---



\### Constraints (must be present)



C1. Surgery-to-room assignment: sum\_r y\[s,r] = 1 for all s  

C2. Room exclusivity: no overlapping surgeries in the same room (NoOverlap on per-room intervals or equivalent logical encoding)  

C3. Surgery-to-anesthetist assignment: sum\_a x\[s,a] = 1 for all s  

C4. Anesthetist exclusivity: no overlaps per anesthetist (NoOverlap or disjunctive logic)  

C5. Buffer rule: if consecutive surgeries for the same anesthetist are in different rooms, start2 >= end1 + BUFFER (in ticks)  

C6. Shift duration bounds: SHIFT\_MIN <= duration\_a <= SHIFT\_MAX (in ticks)  

C7. Cost function: piecewise linear cost per anesthetist with overtime multiplier after SHIFT\_OVERTIME  

C8. Utilization target (if enforced by config): sum(duration\_surgeries) / sum(cost\_anesthetists) >= UTILIZATION\_TARGET  

C9. Feasibility invariants: all intervals within planning horizon; integer time consistency with cfg.time\_unit



---



\### Objective

Primary: Minimize total anesthesiologist cost  

Minimize sum\_a cost\[a]



Optional (if enabled by config): lexicographic or weighted  



Minimize alpha \* sum\_a active\[a] + beta \* sum\_a cost\[a], with alpha >> beta





---



\### Notes for Hyperparameter Tuning

\- Model shape and constraints must be driven solely by `cfg` and reflected in `metadata.modeling\_options`.  

\- `cfg\_hash` enables exact experiment traceability.  

\- `variable\_callback` lets the tuning loop tag or reprioritize variables without altering model semantics.





